# postgres_replication
postgreSQL replication master-slave configuration

# configuration instructions
mkdir -p ./data-master ./tmp-master ./data-standby ./tmp-standby

# add replicator user
add to "/var/lib/postgresql/data/pg_hba.conf"
host replication replicator 0.0.0.0/0 scram-sha-256

# create replication slot on master DB
CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'replicator';
select pg_create_physical_replication_slot('replica_slot');
SELECT * FROM pg_replication_slots;

# back up master DB
on master DB perform a db backup
docker exec -it pg_db_master bash
pg_basebackup -D /tmp -S replica_slot -X stream -P -U replicator -Fp -R

# move backed up files to slave server
mv tmp-master/* data-standby/

# check configuration
nano data-standby/postgresql.auto.conf

# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
# primary_conninfo = 'user=replicator passfile=''/root/.pgpass'' channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable'
primary_conninfo = 'host=pg_db_master port=5432 user=replicator password=replicator'
primary_slot_name = 'replica_slot'
restore_command = 'cp /var/lib/postgresql/data/pg_wal/%f "%p"'
# recovery_target_time = ''


# down the master server 
docker compose down

# add the second server's configuration to docker-compose.yml





